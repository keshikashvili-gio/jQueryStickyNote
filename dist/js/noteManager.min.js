window.note=window.note||{},+function($){"use strict";note.NoteManager=function(element,options){this.options=options,this.$element=$(element),this.notes={},this.dbService={},this.maxId=1,this.eventDelaytimer=0,this.eventDelaytimerMs=300,this.init()},note.NoteManager.prototype={constructor:note.NoteManager,init:function(){console.log("init");var savedData,self=this;self.options=$.extend({},note.NoteManager.DEFAULTS,self.options),"dbLocalStorageService"===self.options.dbService?self.dbService=new note.DbLocalStorageService(self.options.dbLocalStorageOptions):"dbBackendService"===self.options.dbService&&(self.dbService=new note.DbBackendService(self.options.dbBackendOptions)),savedData=self.dbService.getData(),savedData.length?self.notes=savedData:(self.notes=self.options.plainNoteObject,self.dbService.save(self.notes[0])),$.each(self.notes,function(i,item){self.createNote(item)});new note.ContextMenu(note.NoteManager.THEMES,{itemClickCallback:self.themeChangeClickListener.bind(this)})},bindEvents:function($element){$element.find(".sn-btn-add-new").on("click",this.openNewNote.bind(this)),$element.find(".sn-btn-remove").on("click",this.removeNote.bind(this)),$element.find(".sn-editor").on("click, mousedown",function(e){e.stopPropagation()}).on("keyup",this.textEditListener.bind(this))},openNewNote:function(){this.createNote(this.options.plainNoteObject[0]),this.dbService.save(this.options.plainNoteObject[0])},createNote:function(object){var Note=new note.Note(this.$element,object);this.bindEvents(Note.$note),this.initDrag(Note.$note,this.$element),Note.run()},updateNote:function(updatedData){this.dbService.update(updatedData)},removeNote:function(event){var noteNode=$(event.target).parents("."+note.Note.NOTECLASS);$(noteNode).remove(),this.dbService["delete"]($(noteNode).data("id"))},getMaxId:function(){return++this.maxId},toObject:function(){},initDrag:function(){var self=this;interact("."+note.Note.NOTECLASS).draggable({onmove:self.dragMoveListener.bind(this),inertia:!0,restrict:{restriction:"parent",endOnly:!0,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!0,onend:function(event){var textEl=event.target.querySelector("p");textEl&&(textEl.textContent="moved a distance of "+(0|Math.sqrt(event.dx*event.dx+event.dy*event.dy))+"px")}}).resizable({edges:{left:!0,right:!0,bottom:!0,top:!0}}).on("resizemove",self.resizeListener.bind(this))},dragMoveListener:function(event){var self=this,target=event.target,x=(parseFloat(target.getAttribute("data-x"))||0)+event.dx,y=(parseFloat(target.getAttribute("data-y"))||0)+event.dy;console.log("sn-beforeMove"),self.$element.trigger("sn-beforeMove",target,event),target.style.webkitTransform=target.style.transform="translate("+x+"px, "+y+"px)",target.setAttribute("data-x",x),target.setAttribute("data-y",y),this.setEventDelay(function(){console.log("sn-afterMove");var data=note.Note.prototype.htmlToObject(target);self.$element.trigger("sn-afterMove",target,data),self.updateNote(data)},this.eventDelaytimerMs)},resizeListener:function(event){var self=this,target=event.target,x=parseFloat(target.getAttribute("data-x"))||0,y=parseFloat(target.getAttribute("data-y"))||0;console.log("sn-beforeResize"),self.$element.trigger("sn-beforeResize",target,event),target.style.width=event.rect.width+"px",target.style.height=event.rect.height+"px",x+=event.deltaRect.left,y+=event.deltaRect.top,target.style.webkitTransform=target.style.transform="translate("+x+"px,"+y+"px)",target.setAttribute("data-x",x),target.setAttribute("data-y",y),this.setEventDelay(function(){console.log("sn-afterResize");var data=note.Note.prototype.htmlToObject(target);self.$element.trigger("sn-afterResize",target,data),self.updateNote(data)},this.eventDelaytimerMs)},themeChangeClickListener:function(){var link=(arguments[0],arguments[1]),$note=arguments[2],currentTheme=note.Note.prototype.getHTmlClass($note[0].className,"theme-\\w+");$note.removeClass(currentTheme).addClass("theme-"+$(link).data("key")),this.dbService.update(note.Note.prototype.htmlToObject($note))},textEditListener:function(e){var event=e,self=this;this.setEventDelay(function(){console.log("beforeTextChange");var elem=$(event.target).parents("."+note.Note.NOTECLASS),noteObj=note.Note.prototype.htmlToObject(elem);self.$element.trigger("beforeTextChange",noteObj,elem),self.dbService.update(noteObj),self.$element.trigger("afterTextChanged",noteObj,elem),console.log("afterTextChanged")},500)},setEventDelay:function(callback,ms){clearTimeout(this.eventDelaytimer),this.eventDelaytimer=setTimeout(callback,ms)}},note.NoteManager.THEMES=[{name:"blue",value:"#BFE0F5"},{name:"green",value:"#C2F4BD"},{name:"pink",value:"#F0BFF0"},{name:"purple",value:"#D1C8FE"},{name:"white",value:"#F4F4F4"},{name:"yellow",value:"#FDFBB6"}],note.NoteManager.DEFAULTS={plainNoteObject:[{id:1,width:180,height:166,x:300,y:100,text:"",theme:"yellow"}],dbService:"dbLocalStorageService",dbLocalStorageOptions:{localStorageKey:"_jq_sticky_note"},dbBackendOptions:{loadUrl:"",saveUrl:"",updateUrl:"",deleteUrl:"",deleteAllUrl:""}},jQuery.fn.jQueryStickyNote=function(options){return new note.NoteManager(this,options)}}(jQuery);